wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  reboot_timeout: 15min
  ap:
    ssid: "Clock Fallback Hotspot"
captive_portal:
  
api:
  reboot_timeout: 0s

web_server:
  ota: true

esphome:
  name: childrensclock
  platform: ESP32
  board: esp32dev
  name_add_mac_suffix: true
  includes:
    - src/childrensclock.h
  project:
    name: chrisns.childrens-clock
    version: 0.0.1


ota:

logger:
  level: INFO
  baud_rate: 460800

globals:
  - id: progress
    type: int
    restore_value: no
    initial_value: '100'

sensor:
  - name: Progress Percent
    platform: template
    id: progress_percent
    unit_of_measurement: "%"
    state_class: measurement
    icon: mdi:percent
    update_interval: 1s
    lambda: |
      float now = TimeAsDecimal(id(sntp_time).now().hour, id(sntp_time).now().minute);
      int day_of_week = id(sntp_time).now().day_of_week;
      float percent;
      int currentstate = id(current_state).state;
      // TODO: improve logic so progress is calculated right on friday and sunday nights

      if (day_of_week == SAT || day_of_week == SUN) {
        if (currentstate == AMBER) {
          percent = CalculateProgress(now, TimeAsDecimal(id(weekend_bedtime).hour, id(weekend_bedtime).minute), TimeAsDecimal(id(weekend_go).hour, id(weekend_go).minute));
        } else {
          percent = CalculateProgress(now, TimeAsDecimal(id(weekend_bedtime).hour, id(weekend_bedtime).minute), TimeAsDecimal(id(weekend_wake).hour, id(weekend_wake).minute));
        }
      } else {
        if (currentstate == AMBER) {
          percent = CalculateProgress(now, TimeAsDecimal(id(weekday_wake).hour, id(weekday_wake).minute), TimeAsDecimal(id(weekday_go).hour, id(weekday_go).minute));
        } else {
          percent = CalculateProgress(now, TimeAsDecimal(id(weekday_bedtime).hour, id(weekday_bedtime).minute), TimeAsDecimal(id(weekday_wake).hour, id(weekday_wake).minute));
        }
      }
      return percent;
  - name: Current time as decimal
    disabled_by_default: true
    platform: template
    id: current_time_decimal
    state_class: measurement
    icon: mdi:clock-digital
    update_interval: 1s
    lambda: |
      return TimeAsDecimal(id(sntp_time).now().hour, id(sntp_time).now().minute);

  - name: Dots
    disabled_by_default: true
    platform: template
    id: dots
    state_class: measurement
    update_interval: 1s
    lambda: |
      return ProgressToDots(id(progress_percent).state, 32);

  - name: Current state
    disabled_by_default: true
    platform: template
    id: current_state
    state_class: measurement
    update_interval: 1s
    lambda: |
      return GetState(
          id(sntp_time).now().day_of_week,
          id(current_time_decimal).state,
          TimeAsDecimal(id(weekday_go).hour, id(weekday_go).minute),
          TimeAsDecimal(id(weekday_wake).hour, id(weekday_wake).minute),
          TimeAsDecimal(id(weekday_bedtime).hour, id(weekday_bedtime).minute),
          TimeAsDecimal(id(weekend_go).hour, id(weekend_go).minute),
          TimeAsDecimal(id(weekend_wake).hour, id(weekend_wake).minute),
          TimeAsDecimal(id(weekend_bedtime).hour, id(weekend_bedtime).minute)
        );

i2c:
  sda: 18
  scl: 5
  scan: true

time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/London
    servers:
     - 0.pool.ntp.org
     - 1.pool.ntp.org
     - 2.pool.ntp.org
    on_time_sync:
      then:
        - if:
            condition:
              - light.is_off: led_matrix_light
            then:
              - light.turn_on: led_matrix_light

font:
  - id: tinyfont
    file: "lexis.ttf"
    size: 8
    glyphs: \'!"%()+,-_.:*=°?~# 0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ

datetime:
  - platform: template
    id: weekday_go
    type: time
    name: Weekday go
    optimistic: yes
    initial_value: "08:00"
    restore_value: true

  - platform: template
    id: weekday_wake
    type: time
    name: Weekday wake up
    optimistic: yes
    initial_value: "07:00"
    restore_value: true

  - platform: template
    id: weekday_bedtime
    type: time
    name: Weekday bedtime
    optimistic: yes
    initial_value: "18:00"
    restore_value: true

  - platform: template
    id: weekend_go
    type: time
    name: Weekend go
    optimistic: yes
    initial_value: "08:00"
    restore_value: true

  - platform: template
    id: weekend_wake
    type: time
    name: Weekend wake up
    optimistic: yes
    initial_value: "07:00"
    restore_value: true

  - platform: template
    id: weekend_bedtime
    type: time
    name: Weekend bedtime
    optimistic: yes
    initial_value: "18:00"
    restore_value: true

text_sensor:
  - platform: template
    name: Current time
    id: current_time
    disabled_by_default: true
    lambda: |-
      return id(sntp_time).now().strftime("%I:%M");
    update_interval: 1s

light:
  - platform: neopixelbus
    internal: true
    type: GRB
    variant: WS2812
    pin: GPIO13
    num_leds: 256
    name: "Clock Led Matrix"
    id: led_matrix_light
    default_transition_length: 0s
    restore_mode: ALWAYS_ON
    icon: mdi:clock-digital

display:
  - platform: addressable_light
    id: led_matrix_display
    addressable_light_id: led_matrix_light
    width: 32
    height: 8
    rotation: 0°
    pixel_mapper: |-
      if (x % 2 == 0) {
        return (x * 8) + y;
      }
      return (x * 8) + (7 - y);
    lambda: |-
        auto color = Color(0, 0, 0);

        int currentstate = id(current_state).state;

        switch (currentstate) {
          case RED:
            color = Color(28, 0, 0);
            break;
          case AMBER:
            // code block
            break;
          case GREEN:
            color = Color(0, 50, 0);
            break;
        }

        int line_length = id(dots).state;
        
        it.line(0, 0, line_length, 0, color);

        auto time_text = id(current_time).state;

        it.print(
          1,
          1, 
          id(tinyfont),
          color, 
          TextAlign::TOP_LEFT,
          time_text.c_str()
        );